<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>World Class Piano Gallery</title>
  <meta name="theme-color" content="#0d0d0d" />
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    /* ===== THEME TOKENS ===== */
    :root{
      --gold:#b8933b; --gold-strong:#a7812f; --radius:12px; --ease:cubic-bezier(.2,.6,.2,1);
      --navH:88px; /* updates to 68px on scroll via body.nav-small */
    }
    [data-theme="dark"]{
      --bg:#0a0a0a; --bg2:#111; --ink:#fff; --ink-weak:#d8d8d8; --line:rgba(218,183,92,.18);
      --surface:linear-gradient(180deg,#0a0a0a 0%,#161616 60%,#1b1b1b 100%);
      --nav-grad:linear-gradient(180deg,rgba(0,0,0,.85) 0%,rgba(0,0,0,.55) 60%,rgba(0,0,0,.15) 100%);
      --nav-sep:linear-gradient(90deg,transparent, rgba(184,147,59,.5), transparent);
      --theme-color:#0a0a0a;
    }
    [data-theme="light"]{
      --bg:#f3f0e6; --bg2:#fff; --ink:#222; --ink-weak:#555; --line:rgba(180,150,60,.22);
      --surface:linear-gradient(180deg,#f3f0e6 0%,#e9e3d2 60%,#e1d8c2 100%);
      --nav-grad:linear-gradient(180deg,rgba(255,255,255,.95) 0%,rgba(255,255,255,.75) 60%,rgba(255,255,255,.55) 100%);
      --nav-sep:linear-gradient(90deg,transparent, rgba(184,147,59,.35), transparent);
      --theme-color:#f3f0e6;
    }

    /* ===== BASE ===== */
    html,body{margin:0;height:100%}
    body{
      font-family:'Inter',sans-serif; color:var(--ink); background:var(--surface); line-height:1.6;
      transition:background .35s var(--ease), color .35s var(--ease), opacity .25s var(--ease);
    }
    h1,h2,h3{font-family:'Cormorant Garamond',serif; margin:0}
    .container{max-width:1200px; margin:0 auto; padding:0 24px}

    /* ===== PAGE FADE TRANSITION ===== */
    body.fade-enter{opacity:0}
    body.fade-show{opacity:1}
    body.fade-exit{opacity:0}

    /* ===== NAV (MATCHES HOMEPAGE) ===== */
    nav{
      position:fixed; inset:0 0 auto 0; z-index:20;
      background:var(--nav-grad); backdrop-filter:blur(12px);
      border-bottom:1px solid var(--line); box-shadow:0 8px 24px rgba(0,0,0,.35);
      transition:all .35s var(--ease);
    }
    nav .container{display:flex; align-items:center; justify-content:space-between; height:var(--navH); transition:height .35s var(--ease)}
    body.nav-small{--navH:68px}
    .brand{display:flex; align-items:center; gap:.7rem}
    .brand .logo{width:36px; height:36px; border-radius:8px; background:linear-gradient(135deg,var(--gold),var(--gold-strong)); box-shadow:0 6px 16px rgba(0,0,0,.35)}
    .brand .text{color:var(--gold); font-weight:600; white-space:nowrap}
    @media(max-width:860px){.brand .text{display:none}}
    .links{display:flex; align-items:center; gap:1.5rem; flex-wrap:wrap}
    .links a{text-decoration:none; color:var(--ink); opacity:.95; transition:color .2s}
    .links a:hover{color:var(--gold)}
    .theme-toggle{border:none; background:transparent; color:var(--gold); font-size:1.2rem; cursor:pointer; margin-left:.25rem}
    /* gold separator under nav */
    nav::after{content:''; position:absolute; left:0; right:0; bottom:-1px; height:1px; background:var(--nav-sep)}

    /* ===== HEADER ===== */
    header{padding:calc(var(--navH) + 40px) 0 16px}
    header h1{font-size:2.4rem; color:var(--gold); margin-bottom:.25rem}
    header p{color:var(--ink-weak); margin:0}

    /* ===== FILTER BAR (STICKY) ===== */
    .filters{
      position:sticky; top:var(--navH); z-index:10; background:var(--bg2);
      border-top:1px solid var(--line); border-bottom:1px solid var(--line); box-shadow:0 8px 18px rgba(0,0,0,.25)
    }
    .filters .wrap{display:grid; grid-template-columns:repeat(6,1fr); gap:.75rem; align-items:end; padding:.85rem 24px; max-width:1200px; margin:0 auto}
    .filters label{font-size:.8rem; color:var(--ink-weak); display:block; margin-bottom:.25rem}
    .filters select,.filters input[type="search"],.filters input[type="range"]{
      width:100%; background:rgba(0,0,0,.06); border:1px solid var(--line); border-radius:10px; color:var(--ink); padding:.6rem .7rem
    }
    .price-row{grid-column: span 2; display:flex; align-items:center; gap:.65rem}
    .price-value{font-size:.9rem; color:var(--ink-weak); min-width:110px}
    @media(max-width:980px){.filters .wrap{grid-template-columns:repeat(2,1fr)} .price-row{grid-column:span 2}}

    /* ===== GRID ===== */
    .grid{display:grid; grid-template-columns:repeat(3,1fr); gap:1.2rem; padding:1.2rem 24px; max-width:1200px; margin:0 auto 60px}
    @media(max-width:1000px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.grid{grid-template-columns:1fr}}
    .card{
      background:var(--bg2); border:1px solid var(--line); border-radius:12px; overflow:hidden;
      box-shadow:0 16px 36px rgba(0,0,0,.35); transform:translateZ(0);
      transition:transform .35s var(--ease), box-shadow .35s var(--ease), border-color .35s
    }
    .card:hover{transform:translateY(-4px); box-shadow:0 24px 48px rgba(0,0,0,.45); border-color:rgba(184,147,59,.45)}
    .thumb{width:100%; height:220px; object-fit:cover; background:#000}
    .meta{padding:.85rem .95rem}
    .meta h3{font-family:'Cormorant Garamond',serif; margin:.1rem 0 .25rem; font-size:1.4rem; color:var(--ink)}
    .meta .sub{color:var(--ink-weak); font-size:.95rem; margin-bottom:.35rem}
    .meta .price{color:var(--gold); font-weight:600}
    .meta .actions{margin-top:.6rem; display:flex; gap:.6rem}
    .btn{display:inline-block; text-decoration:none; border:1px solid var(--line); padding:.5rem .8rem; border-radius:999px; color:var(--ink); font-size:.92rem}
    .btn.primary{background:linear-gradient(135deg,var(--gold),var(--gold-strong)); color:#111; border:none}

    /* ===== MODAL ===== */
    .modal{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.6); backdrop-filter:blur(6px);
           opacity:0; pointer-events:none; transition:opacity .25s var(--ease); z-index:50}
    .modal.active{opacity:1; pointer-events:auto}
    .panel{width:min(92vw,900px); background:var(--bg2); border:1px solid var(--line); border-radius:14px; box-shadow:0 24px 56px rgba(0,0,0,.5);
           padding:1rem; position:relative; display:grid; grid-template-columns:1fr 1fr; gap:1rem}
    .panel img{width:100%; height:100%; object-fit:cover; border-radius:10px; border:1px solid var(--line)}
    .panel .details{padding:.25rem .5rem}
    .panel .details h3{font-family:'Cormorant Garamond',serif; color:var(--gold); margin:.25rem 0 .5rem; font-size:1.8rem}
    .panel .row{display:grid; grid-template-columns:140px 1fr; gap:.6rem; margin:.25rem 0; color:var(--ink-weak)}
    .panel .row strong{color:var(--ink)}
    .close{position:absolute; top:8px; right:10px; background:none; border:none; color:var(--ink); font-size:1.6rem; cursor:pointer}
    @media(max-width:860px){.panel{grid-template-columns:1fr}}

    /* ===== REVEAL + LOADER ===== */
    .reveal{opacity:0; transform: translateY(14px); transition: opacity .6s ease-in-out, transform .6s ease-in-out}
    .reveal.show{opacity:1; transform: translateY(0)}
    .loader-wrap{display:flex; align-items:center; justify-content:center; min-height:40vh}
    .loader{width:52px; height:52px; border-radius:50%; border:3px solid var(--line); border-top-color:var(--gold); animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body class="fade-enter">

  <!-- NAV -->
  <nav id="nav">
    <div class="container">
      <div class="brand">
        <div class="logo"></div>
        <div class="text">World Class Piano Gallery</div>
      </div>
      <div class="links">
        <a href="index.html">Home</a>
        <a href="about.html">About</a>
        <a href="pianos.html">Gallery</a>
        <a href="services.html">Services</a>
        <a href="tradein.html">Trade-In</a>
        <a href="contact.html">Contact</a>
        <button class="theme-toggle" id="themeBtn" aria-label="Toggle theme">
          <!-- sun -->
          <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.8 1.42-1.42zm10.48 14.32l1.79 1.8 1.41-1.41-1.8-1.79-1.4 1.4zM12 4V1h0v3h0zm0 19v-3h0v3h0zM4 12H1v0h3v0zm19 0h-3v0h3v0zM6.76 19.16l-1.42 1.42-1.79-1.8 1.41-1.41 1.8 1.79zM19.16 6.76l1.4-1.4 1.8 1.79-1.41 1.41-1.79-1.8zM12 7a5 5 0 100 10 5 5 0 000-10z"/></svg>
          <!-- moon -->
          <svg id="moon" style="display:none" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
        </button>
      </div>
    </div>
  </nav>

  <!-- HEADER -->
  <header>
    <div class="container">
      <h1>World Class Piano Gallery</h1>
      <p>Explore our current selection of grand and upright pianos.</p>
    </div>
  </header>

  <!-- FILTERS -->
  <div class="filters">
    <div class="wrap">
      <div>
        <label>Brand</label>
        <select id="brandSel"><option value="">All</option></select>
      </div>
      <div>
        <label>Color</label>
        <select id="colorSel"><option value="">All</option></select>
      </div>
      <div>
        <label>Length</label>
        <select id="lengthSel"><option value="">All</option></select>
      </div>
      <div>
        <label>Warranty</label>
        <select id="warrantySel"><option value="">All</option></select>
      </div>
      <div>
        <label>Search</label>
        <input id="searchBox" type="search" placeholder="Model or Serial…">
      </div>
      <div class="price-row">
        <label style="margin:0">Max Price</label>
        <input id="priceRange" type="range" min="0" max="200000" step="500">
        <div class="price-value" id="priceVal">$200,000</div>
      </div>
    </div>
  </div>

  <!-- LOADER -->
  <div id="loader" class="loader-wrap"><div class="loader" aria-label="Loading..."></div></div>

  <!-- GRID -->
  <main id="grid" class="grid" style="display:none;"></main>

  <!-- MODAL -->
  <div class="modal" id="modal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true">
      <button class="close" id="closeModal" aria-label="Close">×</button>
      <img id="modalImg" alt="Piano">
      <div class="details">
        <h3 id="modalTitle">Piano</h3>
        <div class="row"><strong>Brand</strong><div id="mBrand">—</div></div>
        <div class="row"><strong>Model</strong><div id="mModel">—</div></div>
        <div class="row"><strong>Year</strong><div id="mYear">—</div></div>
        <div class="row"><strong>Color</strong><div id="mColor">—</div></div>
        <div class="row"><strong>Length</strong><div id="mLength">—</div></div>
        <div class="row"><strong>Serial</strong><div id="mSerial">—</div></div>
        <div class="row"><strong>Warranty</strong><div id="mWarranty">—</div></div>
        <div class="row"><strong>Price</strong><div id="mPrice">—</div></div>
        <div class="row"><strong>Status</strong><div id="mStatus">—</div></div>
        <div style="margin-top:1rem">
          <a href="contact.html" class="btn primary">Contact Us</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
    /* ===== THEME TOGGLE (same as other pages) ===== */
    const htmlEl=document.documentElement,btn=document.getElementById('themeBtn'),
      sun=document.getElementById('sun'),moon=document.getElementById('moon');
    function applyTheme(m){if(!m)m='auto'; htmlEl.setAttribute('data-theme',m);
      const d=(m==='dark')||(m==='auto'&&window.matchMedia('(prefers-color-scheme:dark)').matches);
      if(sun&&moon){sun.style.display=d?'none':'';moon.style.display=d?'':'none';}
      const meta=document.querySelector('meta[name="theme-color"]'); if(meta) meta.setAttribute('content',d?'#0a0a0a':'#f3f0e6');}
    const saved=localStorage.getItem('wcpg-theme')||'auto'; applyTheme(saved);
    window.matchMedia('(prefers-color-scheme:dark)').addEventListener('change',()=>{ if((localStorage.getItem('wcpg-theme')||'auto')==='auto') applyTheme('auto'); });
    if(btn){btn.addEventListener('click',()=>{const c=htmlEl.getAttribute('data-theme')||'auto';const n=c==='auto'?'dark':c==='dark'?'light':'auto';localStorage.setItem('wcpg-theme',n);applyTheme(n);});}

    /* ===== NAV SHRINK + PAGE FADE ===== */
    const nav=document.getElementById('nav');
    const onScroll=()=>document.body.classList.toggle('nav-small',window.scrollY>20);
    window.addEventListener('scroll',onScroll,{passive:true}); onScroll();

    // Page fade in
    window.addEventListener('DOMContentLoaded',()=>{document.body.classList.remove('fade-enter'); document.body.classList.add('fade-show');});
    // Page fade out for internal links
    document.querySelectorAll('a[href$=".html"]').forEach(a=>{
      a.addEventListener('click',e=>{
        const url=new URL(a.href, location.href);
        if(url.origin===location.origin){
          e.preventDefault();
          document.body.classList.add('fade-exit');
          setTimeout(()=>location.href=a.href, 150);
        }
      });
    });

    /* ===== REVEAL SETUP ===== */
    const revealsCb=(entries,io)=>{entries.forEach(ent=>{if(ent.isIntersecting){ent.target.classList.add('show'); io.unobserve(ent.target);}})};
    const io=new IntersectionObserver(revealsCb,{threshold:.18});
    const reveal=(el)=>{el.classList.add('reveal'); io.observe(el);};

    /* ===== FIREBASE CONFIG (yours) ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyA2932IBDCeUix6OdRaJMDIisHX0SbyDFo",
      authDomain: "pianoinv.firebaseapp.com",
      projectId: "pianoinv",
      storageBucket: "pianoinv.firebasestorage.app",
      messagingSenderId: "651707888262",
      appId: "1:651707888262:web:23131a782e31a7bb511707",
      measurementId: "G-1XQLEV28JZ"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    /* ===== ELEMENTS ===== */
    const grid = document.getElementById('grid');
    const loader = document.getElementById('loader');
    const brandSel = document.getElementById('brandSel');
    const colorSel = document.getElementById('colorSel');
    const lengthSel = document.getElementById('lengthSel');
    const warrantySel = document.getElementById('warrantySel');
    const priceRange = document.getElementById('priceRange');
    const priceVal = document.getElementById('priceVal');
    const searchBox = document.getElementById('searchBox');

    const modal = document.getElementById('modal');
    const closeModalBtn = document.getElementById('closeModal');
    const mEls = {
      img: document.getElementById('modalImg'),
      title: document.getElementById('modalTitle'),
      brand: document.getElementById('mBrand'),
      model: document.getElementById('mModel'),
      year: document.getElementById('mYear'),
      color: document.getElementById('mColor'),
      length: document.getElementById('mLength'),
      serial: document.getElementById('mSerial'),
      warranty: document.getElementById('mWarranty'),
      price: document.getElementById('mPrice'),
      status: document.getElementById('mStatus')
    };

    /* ===== HELPERS ===== */
    function fmtPrice(v){
      if(v===undefined || v===null || v==='') return 'Inquire for Price';
      const n = Number(v); if(Number.isNaN(n)) return String(v);
      return n.toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0});
    }
    function fromGsUrl(url){
      try{ if(!url.startsWith('gs://')) return null; const no=url.replace('gs://',''); const parts=no.split('/'); parts.shift(); return parts.join('/'); }
      catch(e){ return null; }
    }
    async function getImageUrl(photoURL){
      if(!photoURL) return '';
      if(photoURL.startsWith('http')) return photoURL;
      if(photoURL.startsWith('gs://')){
        const path = fromGsUrl(photoURL); if(!path) return '';
        try{ const ref = storage.ref(path); return await ref.getDownloadURL(); }
        catch(e){ console.warn('getDownloadURL failed', e); return ''; }
      }
      return photoURL;
    }

    /* ===== DATA / FILTERS ===== */
    let ALL_DOCS = [];
    let PRICE_MAX = 200000;

    function populateFilters(docs){
      const brands=new Set(), colors=new Set(), lengths=new Set(), warranties=new Set();
      let maxPrice=0;
      docs.forEach(d=>{
        if(d.brand) brands.add(d.brand);
        if(d.color) colors.add(d.color);
        if(d.length) lengths.add(d.length);
        if(d.warranty) warranties.add(d.warranty);
        const p=Number(d.price||0); if(!Number.isNaN(p)) maxPrice=Math.max(maxPrice,p);
      });
      function fill(sel,set){const cur=sel.value; sel.innerHTML='<option value=\"\">All</option>'+[...set].sort().map(v=>`<option>${v}</option>`).join(''); if(cur) sel.value=cur;}
      fill(brandSel,brands); fill(colorSel,colors); fill(lengthSel,lengths); fill(warrantySel,warranties);
      PRICE_MAX=Math.max(1000, Math.ceil(maxPrice/5000)*5000); priceRange.max=String(PRICE_MAX);
      if(!priceRange.value) priceRange.value=String(PRICE_MAX); priceVal.textContent=fmtPrice(priceRange.value);
    }

    function passFilters(d,q){
      if(brandSel.value && (d.brand||'') !== brandSel.value) return false;
      if(colorSel.value && (d.color||'') !== colorSel.value) return false;
      if(lengthSel.value && (d.length||'') !== lengthSel.value) return false;
      if(warrantySel.value && (d.warranty||'') !== warrantySel.value) return false;
      const maxP = Number(priceRange.value||PRICE_MAX); const price = Number(d.price||0);
      if(!Number.isNaN(price) && price > maxP) return false;
      if(q){ const hay=((d.brand||'')+' '+(d.model||'')+' '+(d.serial||'')).toLowerCase(); if(!hay.includes(q.toLowerCase())) return false; }
      return true;
    }

    function cardTemplate(d){
      return `
        <article class="card reveal">
          <img class="thumb" alt="${(d.brand||'')+' '+(d.model||'Piano')}" src="${d._img||''}"/>
          <div class="meta">
            <h3>${(d.brand||'') + ' ' + (d.model||'')}</h3>
            <div class="sub">${[d.color, d.year].filter(Boolean).join(' • ')}</div>
            <div class="price">${fmtPrice(d.price)}</div>
            <div class="actions">
              <button class="btn" data-id="${d._id}" data-act="details">View Details</button>
            </div>
          </div>
        </article>`;
    }

    function render(){
      const q = searchBox.value.trim();
      const list = ALL_DOCS.filter(d=>passFilters(d,q));
      grid.innerHTML = list.map(cardTemplate).join('');
      grid.querySelectorAll('[data-act="details"]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const d = ALL_DOCS.find(x=>x._id===btn.dataset.id); if(d) openModal(d);
        });
      });
      // reveal
      grid.querySelectorAll('.card').forEach(el=>reveal(el));
      loader.style.display='none'; grid.style.display='grid';
    }

    function openModal(d){
      mEls.img.src = d._img || '';
      mEls.title.textContent = (d.brand||'') + ' ' + (d.model||'');
      mEls.brand.textContent = d.brand||'—';
      mEls.model.textContent = d.model||'—';
      mEls.year.textContent = d.year||'—';
      mEls.color.textContent = d.color||'—';
      mEls.length.textContent = d.length||'—';
      mEls.serial.textContent = d.serial||'—';
      mEls.warranty.textContent = d.warranty||'—';
      mEls.price.textContent = fmtPrice(d.price);
      mEls.status.textContent = d.status||'Available';
      modal.classList.add('active'); modal.setAttribute('aria-hidden','false');
    }
    function closeModal(){ modal.classList.remove('active'); modal.setAttribute('aria-hidden','true'); }
    document.getElementById('closeModal').addEventListener('click', closeModal);
    window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });
    window.addEventListener('click', e=>{ if(e.target===modal) closeModal(); });

    async function load(){
      try{
        const snap = await db.collection('pianos').get();
        const docs = [];
        for(const doc of snap.docs){
          const d = doc.data();
          // show active (no archive reason)
          if (d.archiveReason !== undefined && d.archiveReason !== null && d.archiveReason !== '') continue;
          d._img = await getImageUrl(d.photoURL || '');
          d._id = doc.id;
          docs.push(d);
        }
        ALL_DOCS = docs;
        populateFilters(ALL_DOCS);
        render();
      }catch(err){
        console.error(err);
        loader.innerHTML = '<p style="color:var(--ink-weak)">Failed to load inventory.</p>';
      }
    }
    load();

    // filter events
    [brandSel,colorSel,lengthSel,warrantySel].forEach(sel=> sel.addEventListener('change', render));
    priceRange.addEventListener('input', ()=>{ priceVal.textContent = fmtPrice(priceRange.value); render(); });
    searchBox.addEventListener('input', render);
  </script>
</body>
</html>
